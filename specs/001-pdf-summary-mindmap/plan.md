# Implementation Plan: PDF Upload with Summaries and Mindmap Generation

**Branch**: `001-pdf-summary-mindmap` | **Date**: November 10, 2025 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-pdf-summary-mindmap/spec.md`

**Note**: This plan is generated by `/speckit.plan` and guides Phase 0 (Research), Phase 1 (Design), and Phase 2 (Implementation).

## Summary

Build a document processing application that enables users to upload PDFs, generate AI-powered summaries and hierarchical mindmaps. The application uses FastAPI for backend document processing and Gemini API integration, Next.js for responsive frontend UI, and PostgreSQL for document and metadata persistence. Core value: transform large PDFs into digestible summaries and visual mindmaps within <5s, with robust error handling and rate-limit protection.

## Technical Context

**Backend Language/Version**: Python 3.12 (FastAPI framework)  
**Frontend Language/Version**: JavaScript/TypeScript with React 18 (Next.js 15+)  
**Primary Dependencies**:

- Backend: FastAPI 0.120.0, python-multipart, PyPDF2 (or pypdf), pydantic, google-genai SDK, sqlalchemy, alembic
- Frontend: Next.js 15+, React 18, TailwindCSS, Axios, zustand (state management)

**Storage**:

- PostgreSQL 16 (documents, summaries, mindmaps, metadata)
- Optional: Redis (caching for repeated summaries/mindmaps)

**Testing**:

- Backend: pytest, pytest-asyncio, unittest.mock, httpx (async HTTP testing)
- Frontend: Jest, React Testing Library, Playwright (E2E)

**LLM Integration**: Google Generative AI (Gemini API)
**Target Platform**: Linux server (backend), modern web browsers (frontend)  
**Project Type**: Full-stack web application (backend API + SPA frontend)  
**Performance Goals**:

- Summary generation: <5s p95 (via Gemini API)
- Mindmap generation: <2s p95 (formatted output)
- PDF upload + parse: <3s for typical documents (up to 100MB)
- UI page load: <2s (including assets)

**Constraints**:

- PDF max size: 100MB
- Memory per PDF processing: <500MB
- Concurrent upload queue: max 50 jobs
- Gemini API rate limiting: enforce with queue backoff
- Token efficiency: track and optimize Gemini API consumption

**Scale/Scope**:

- MVP: Single-file uploads, sequential processing
- User base: Initially individual/small team usage (assume <100 concurrent users)
- Document retention: 30 days by default (configurable)
- Document types: PDF (v1.0), potential expansion to DOCX, TXT

## Constitution Check

_GATE: All violations must be justified before proceeding. Re-evaluate after Phase 1 design._

### ✅ I. Test-Driven Quality

**Status**: PASS (with implementation discipline required)  
**Notes**:

- TDD enforced for all feature implementations (unit test coverage ≥80%)
- Contract tests required for Gemini API abstraction layer
- Integration tests mandatory for PDF parsing pipeline and document summarization workflows
- All acceptance scenarios in spec.md are independently testable

**Action**: CI/CD pipeline must enforce test coverage gates before merge

### ✅ II. Code Clarity & Maintainability

**Status**: PASS (with architectural decisions required)

- SOLID principles will guide backend service architecture (PDF Parser Service, Summary Service, Mindmap Service)
- DRY enforced through shared utilities (error handling, logging, validation)
- API abstraction layer required to decouple from Gemini SDK
- Max file size: 1600 lines per module; frontend components max 400 lines

**Action**: Establish code review checklist referencing SOLID principles

### ✅ III. Performance Excellence

**Status**: PASS (with monitoring required)

- Performance targets: Summary <5s, Mindmap <2s, Upload <3s (aligned with spec acceptance criteria)
- Caching strategy: LRU cache (1GB limit) for repeated summaries/mindmaps
- Gemini API rate limiting enforced before each request; queue with exponential backoff
- Performance tests required for all Gemini API operations

**Action**: Implement monitoring dashboard to track API latency and token consumption

### ✅ IV. Robust Error Handling

**Status**: PASS (with graceful degradation strategy)

- All errors logged with context (document ID, operation, timestamp)
- User-facing errors non-technical (e.g., "File too large" vs. "BufferError")
- Graceful degradation: if mindmap fails, summary still delivered
- Gemini API failures trigger retry with exponential backoff (max 3 retries)
- Timeout: 30s max for summary, 20s for mindmap; fail fast if exceeded

**Action**: Define error codes and user messages in error handling spec

### ✅ V. API Integration Discipline

**Status**: PASS (with implementation guardrails)

- API abstraction layer mandatory; no direct Gemini SDK calls from business logic
- Contract tests for all Gemini endpoints (mock responses)
- Fallback strategy: retry backoff → local cache → graceful message
- Rate limit checking before each request; queue if approaching limits
- Cost tracking: log tokens per operation; alert if weekly spend exceeds budget
- API key via environment variables (never hardcoded); rotation policy documented

**Action**: Create `backend/services/gemini_service.py` abstraction; add cost tracking middleware

**Overall Gate Result**: ✅ **PASS** - All principles aligned. Proceed to Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/001-pdf-summary-mindmap/
├── plan.md              # This file (generated)
├── research.md          # Phase 0 output (to be generated)
├── data-model.md        # Phase 1 output (to be generated)
├── quickstart.md        # Phase 1 output (to be generated)
├── contracts/           # Phase 1 output (to be generated)
│   ├── gemini-api.md
│   ├── backend-api.yaml (OpenAPI)
│   └── frontend-contract.md
└── spec.md              # Original feature specification
```

### Source Code Structure

```text
backend/
├── src/
│   ├── main.py                      # FastAPI app initialization
│   ├── config.py                    # Configuration management
│   ├── models/
│   │   ├── document.py              # SQLAlchemy models
│   │   ├── summary.py
│   │   └── mindmap.py
│   ├── services/
│   │   ├── pdf_service.py           # PDF parsing + extraction
│   │   ├── gemini_service.py        # Gemini API abstraction (rate limiting, caching, fallbacks)
│   │   ├── summary_service.py       # Summary generation orchestration
│   │   ├── mindmap_service.py       # Mindmap generation + formatting
│   │   └── document_service.py      # CRUD operations
│   ├── api/
│   │   ├── routes/
│   │   │   ├── documents.py         # Upload, list, get document
│   │   │   ├── summaries.py         # Generate, get summaries
│   │   │   └── mindmaps.py          # Generate, get mindmaps
│   │   └── schemas.py               # Pydantic request/response models
│   ├── utils/
│   │   ├── error_handler.py         # Centralized error handling
│   │   ├── logger.py                # Structured logging
│   │   └── validators.py            # Input validation
│   └── middleware/
│       ├── error_middleware.py
│       └── cors_middleware.py
├── tests/
│   ├── unit/
│   │   ├── test_pdf_service.py
│   │   ├── test_summary_service.py
│   │   ├── test_gemini_service.py
│   │   └── test_validators.py
│   ├── integration/
│   │   ├── test_document_flow.py    # Upload → Parse → Generate
│   │   └── test_gemini_integration.py
│   ├── contract/
│   │   ├── test_gemini_contract.py  # Mock Gemini responses
│   │   └── test_api_contract.py
│   └── e2e/
│       ├── test_full_workflow.py    # Selenium/Playwright
│       └── conftest.py              # E2E fixtures
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
├── alembic/                         # Database migrations
│   ├── versions/
│   └── env.py
└── README.md

frontend/
├── src/
│   ├── pages/
│   │   ├── index.tsx                # Home/dashboard
│   │   ├── documents/[id].tsx       # Document detail view
│   │   └── _app.tsx                 # App wrapper
│   ├── components/
│   │   ├── DocumentUpload.tsx       # File upload component
│   │   ├── DocumentList.tsx         # Document list/grid
│   │   ├── SummaryView.tsx          # Display summary
│   │   ├── MindmapView.tsx          # Display interactive mindmap
│   │   └── LoadingSpinner.tsx       # Loading states
│   ├── services/
│   │   ├── api.ts                   # Axios client + request/response interceptors
│   │   └── store.ts                 # Zustand state management
│   ├── types/
│   │   └── index.ts                 # TypeScript interfaces
│   ├── styles/
│   │   └── globals.css              # TailwindCSS setup
│   └── utils/
│       ├── errorFormatter.ts        # Format API errors for UI
│       └── validators.ts            # Client-side validation
├── tests/
│   ├── unit/
│   │   └── utils.test.ts
│   └── e2e/
│       ├── upload.spec.ts
│       └── generate.spec.ts
├── package.json
├── next.config.js
├── tailwind.config.js
├── tsconfig.json
└── README.md

shared/
├── types.ts                         # Shared TypeScript types
└── constants.ts
```

**Structure Decision**: Full-stack web application with separated backend (FastAPI) and frontend (Next.js). Backend handles all document processing, Gemini API calls, and database operations. Frontend provides responsive UI for uploads, document viewing, and summary/mindmap display. This separation enables independent scaling and deployment.

| Violation                  | Why Needed         | Simpler Alternative Rejected Because |
| -------------------------- | ------------------ | ------------------------------------ |
| [e.g., 4th project]        | [current need]     | [why 3 projects insufficient]        |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient]  |
